CREATE OR REPLACE VIEW knee_pivot_table AS
SELECT
    s.subject_id,
    s.age,
    s.gender,
    s.weight_lbs,
    s.weight_kg,
    s.height_in,
    s.height_cm,
    s.knee_injury,
    s.dom_limb,
    s.surgery_limb,
    ts.session_date,
    ts.time_since_sx,

    -- Clinical scores
  MAX(sm.value) FILTER (WHERE m.name = 'IKDC')          AS ikdc,
  MAX(sm.value) FILTER (WHERE m.name = 'KOOSPain')     AS koos_pain,
  MAX(sm.value) FILTER (WHERE m.name = 'KOOSSymptom')  AS koos_symptom,
  MAX(sm.value) FILTER (WHERE m.name = 'KOOSADL')      AS koos_adl,
  MAX(sm.value) FILTER (WHERE m.name = 'KOOSSportRec') AS koos_sport_rec,
  MAX(sm.value) FILTER (WHERE m.name = 'KOOSQoL')      AS koos_qol,
  MAX(sm.value) FILTER (WHERE m.name = 'ACL-RSI')      AS acl_rsi,
  MAX(sm.value) FILTER (WHERE m.name = 'Tegner-Pre')   AS tegner_pre,
  MAX(sm.value) FILTER (WHERE m.name = 'Tegner-Current') AS tegner_current,
    
    -- Strength / Force measurements (involved limb)
  MAX(sm.value) FILTER (WHERE m.name = 'MaxForce1Inv') AS max_force_1_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'PreMVC1Inv')   AS pre_mvc_1_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'RT1Inv')       AS rt_1_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'MaxForce2Inv') AS max_force_2_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'PreMVC2Inv')   AS pre_mvc_2_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'RT2Inv')       AS rt_2_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'MVCAvgInv')    AS mvc_avg_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'MVCMaxInv')    AS mvc_max_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTAvgInv')     AS rt_avg_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTMaxInv')     AS rt_max_inv,
    
  MAX(sm.value) FILTER (WHERE m.name = 'PerAct1Inv')   AS per_act_1_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'PerAct2Inv')   AS per_act_2_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'PerActAvgInv') AS per_act_avg_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'PerActMaxInv') AS per_act_max_inv,
    
    -- Uninvolved limb
  MAX(sm.value) FILTER (WHERE m.name = 'MaxForce1Uninv') AS max_force_1_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'PreMVC1Uninv')   AS pre_mvc_1_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'RT1Uninv')       AS rt_1_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'MaxForce2Uninv') AS max_force_2_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'PreMVC2Uninv')   AS pre_mvc_2_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'RT2Uninv')       AS rt_2_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'MVCAvgUninv')    AS mvc_avg_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'MVCMaxUninv')    AS mvc_max_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTAvgUninv')     AS rt_avg_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTMaxUninv')     AS rt_max_uninv,
    
  MAX(sm.value) FILTER (WHERE m.name = 'PerAct1Uninv')   AS per_act_1_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'PerAct2Uninv')   AS per_act_2_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'PerActAvgUninv') AS per_act_avg_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'PerActMaxUninv') AS per_act_max_uninv,
    
    -- Rate of torque development & IMP (involved limb)
  MAX(sm.value) FILTER (WHERE m.name = 'MVCRTDMaxAvgInv') AS mvc_rtd_max_avg_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'MVCRTDMaxMaxInv') AS mvc_rtd_max_max_inv,
    
  MAX(sm.value) FILTER (WHERE m.name = 'RTD50AvgInv')  AS rtd_50_avg_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD50MaxInv')  AS rtd_50_max_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD100AvgInv') AS rtd_100_avg_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD100MaxInv') AS rtd_100_max_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD150AvgInv') AS rtd_150_avg_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD150MaxInv') AS rtd_150_max_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD200AvgInv') AS rtd_200_avg_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD200MaxInv') AS rtd_200_max_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD250AvgInv') AS rtd_250_avg_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD250MaxInv') AS rtd_250_max_inv,
    
  MAX(sm.value) FILTER (WHERE m.name = 'IMP50AvgInv')  AS imp_50_avg_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP50MaxInv')  AS imp_50_max_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP100AvgInv') AS imp_100_avg_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP100MaxInv') AS imp_100_max_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP150AvgInv') AS imp_150_avg_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP150MaxInv') AS imp_150_max_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP200AvgInv') AS imp_200_avg_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP200MaxInv') AS imp_200_max_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP250AvgInv') AS imp_250_avg_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP250MaxInv') AS imp_250_max_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'IMPAvgAvgInv') AS imp_avg_avg_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'IMPAvgMaxInv') AS imp_avg_max_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'MVCRTDMaxAvgUninv') AS mvc_rtd_max_avg_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'MVCRTDMaxMaxUninv') AS mvc_rtd_max_max_uninv,
  
  MAX(sm.value) FILTER (WHERE m.name = 'RTD50AvgUninv')  AS rtd_50_avg_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD50MaxUninv')  AS rtd_50_max_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD100AvgUninv') AS rtd_100_avg_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD100MaxUninv') AS rtd_100_max_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD150AvgUninv') AS rtd_150_avg_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD150MaxUninv') AS rtd_150_max_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD200AvgUninv') AS rtd_200_avg_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD200MaxUninv') AS rtd_200_max_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD250AvgUninv') AS rtd_250_avg_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD250MaxUninv') AS rtd_250_max_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTDMaxAvgUninv') AS rtd_max_avg_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTDMaxMaxUninv') AS rtd_max_max_uninv,
  
  MAX(sm.value) FILTER (WHERE m.name = 'IMP50AvgUninv')  AS imp_50_avg_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP50MaxUninv')  AS imp_50_max_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP100AvgUninv') AS imp_100_avg_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP100MaxUninv') AS imp_100_max_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP150AvgUninv') AS imp_150_avg_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP150MaxUninv') AS imp_150_max_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP200AvgUninv') AS imp_200_avg_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP200MaxUninv') AS imp_200_max_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP250AvgUninv') AS imp_250_avg_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP250MaxUninv') AS imp_250_max_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'IMPAvgAvgUninv') AS imp_avg_avg_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'IMPAvgMaxUninv') AS imp_avg_max_uninv,
  
  MAX(sm.value) FILTER (WHERE m.name = 'MaxForce1LSI') AS max_force_1_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'PreMVC1LSI')   AS pre_mvc_1_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'RT1LSI')       AS rt_1_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'MaxForce2LSI') AS max_force_2_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'PreMVC2LSI')   AS pre_mvc_2_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'RT2LSI')       AS rt_2_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'MVCAvgLSI')    AS mvc_avg_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'MVCMaxLSI')    AS mvc_max_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'RTAvgLSI')     AS rt_avg_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'RTMaxLSI')     AS rt_max_lsi,
  
  MAX(sm.value) FILTER (WHERE m.name = 'PerAct1LSI')   AS per_act_1_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'PerAct2LSI')   AS per_act_2_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'PerActAvgLSI') AS per_act_avg_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'PerActMaxLSI') AS per_act_max_lsi,
  
  MAX(sm.value) FILTER (WHERE m.name = 'MVCRTDMaxAvgLSI') AS mvc_rtd_max_avg_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'MVCRTDMaxMaxLSI') AS mvc_rtd_max_max_lsi,
  
  MAX(sm.value) FILTER (WHERE m.name = 'RTD50AvgLSI')  AS rtd_50_avg_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD50MaxLSI')  AS rtd_50_max_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD100AvgLSI') AS rtd_100_avg_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD100MaxLSI') AS rtd_100_max_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD150AvgLSI') AS rtd_150_avg_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD150MaxLSI') AS rtd_150_max_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD200AvgLSI') AS rtd_200_avg_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD200MaxLSI') AS rtd_200_max_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD250AvgLSI') AS rtd_250_avg_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD250MaxLSI') AS rtd_250_max_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'RTDMaxAvgLSI') AS rtd_max_avg_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'RTDMaxMaxLSI') AS rtd_max_max_lsi,
  
  MAX(sm.value) FILTER (WHERE m.name = 'IMP50AVGLSI')  AS imp_50_avg_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP50MAXLSI')  AS imp_50_max_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP100AVGLSI') AS imp_100_avg_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP100MAXLSI') AS imp_100_max_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP150AVGLSI') AS imp_150_avg_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP150MAXLSI') AS imp_150_max_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP200AVGLSI') AS imp_200_avg_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP200MAXLSI') AS imp_200_max_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP250AVGLSI') AS imp_250_avg_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP250MAXLSI') AS imp_250_max_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'IMPAVGAVGLSI') AS imp_avg_avg_lsi,
  MAX(sm.value) FILTER (WHERE m.name = 'IMPAVGMAXLSI') AS imp_avg_max_lsi,
  
  MAX(sm.value) FILTER (WHERE m.name = 'MVCRTDMaxNormInv') AS mvc_rtd_max_norm_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD50NormInv')     AS rtd_50_norm_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD100NormInv')   AS rtd_100_norm_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD150NormInv')   AS rtd_150_norm_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD200NormInv')   AS rtd_200_norm_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD250NormInv')   AS rtd_250_norm_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTDMaxNormInv')   AS rtd_max_norm_inv,
  
  MAX(sm.value) FILTER (WHERE m.name = 'IMP50NormInv')  AS imp_50_norm_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP100NormInv') AS imp_100_norm_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP150NormInv') AS imp_150_norm_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP200NormInv') AS imp_200_norm_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP250NormInv') AS imp_250_norm_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'IMPAVGNormInv') AS imp_avg_norm_inv,
  
  MAX(sm.value) FILTER (WHERE m.name = 'MVCRTDMaxNormUninv') AS mvc_rtd_max_norm_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD50NormUninv')     AS rtd_50_norm_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD100NormUninv')   AS rtd_100_norm_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD150NormUninv')   AS rtd_150_norm_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD200NormUninv')   AS rtd_200_norm_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTD250NormUninv')   AS rtd_250_norm_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'RTDMaxNormUninv')   AS rtd_max_norm_uninv,
  
  MAX(sm.value) FILTER (WHERE m.name = 'IMP50NormUninv')  AS imp_50_norm_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP100NormUninv') AS imp_100_norm_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP150NormUninv') AS imp_150_norm_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP200NormUninv') AS imp_200_norm_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'IMP250NormUninv') AS imp_250_norm_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'IMPAVGNormUninv') AS imp_avg_norm_uninv,
  
  MAX(sm.value) FILTER (WHERE m.name = 'SEBTAnteriorInv')        AS sebt_anterior_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'SEBTPosteromedialInv')  AS sebt_posteromedial_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'SEBTPosterolateralInv') AS sebt_posterolateral_inv,
  MAX(sm.value) FILTER (WHERE m.name = 'CompositeInv')          AS composite_inv,
  
  MAX(sm.value) FILTER (WHERE m.name = 'SEBTAnteriorUninv')        AS sebt_anterior_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'SEBTPosteromedialUninv')  AS sebt_posteromedial_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'SEBTPosterolateralUninv') AS sebt_posterolateral_uninv,
  MAX(sm.value) FILTER (WHERE m.name = 'CompositeUninv')          AS composite_uninv,
  
  MAX(sm.value) FILTER (WHERE m.name = 'DropJumpAvg')        AS drop_jump_avg,
  MAX(sm.value) FILTER (WHERE m.name = 'DropJumpMax')        AS drop_jump_max,
  MAX(sm.value) FILTER (WHERE m.name = 'BilateralJumpAVG')   AS bilateral_jump_avg,
  MAX(sm.value) FILTER (WHERE m.name = 'BilateralJumpMax')   AS bilateral_jump_max,
  
  MAX(sm.value) FILTER (WHERE m.name = 'UnilateralJumpNonDomAvg') AS unilateral_jump_non_dom_avg,
  MAX(sm.value) FILTER (WHERE m.name = 'UnilateralJumpNonDomMax') AS unilateral_jump_non_dom_max,
  MAX(sm.value) FILTER (WHERE m.name = 'UnilateralJumpDomAvg')    AS unilateral_jump_dom_avg,
  MAX(sm.value) FILTER (WHERE m.name = 'UnilateralJumpDomMax')    AS unilateral_jump_dom_max,
  
  MAX(sm.value) FILTER (WHERE m.name = 'ForwardHopNonDomAvg') AS forward_hop_non_dom_avg,
  MAX(sm.value) FILTER (WHERE m.name = 'ForwardHopNonDomMax') AS forward_hop_non_dom_max,
  MAX(sm.value) FILTER (WHERE m.name = 'ForwardHopDomAvg')    AS forward_hop_dom_avg,
  MAX(sm.value) FILTER (WHERE m.name = 'ForwardHopDomMax')    AS forward_hop_dom_max,
  
  MAX(sm.value) FILTER (WHERE m.name = 'SidehopNonDom') AS side_hop_non_dom,
  MAX(sm.value) FILTER (WHERE m.name = 'SideHopDom')    AS side_hop_dom,
  MAX(sm.value) FILTER (WHERE m.name = 'StepDownNonDom') AS step_down_non_dom,
  MAX(sm.value) FILTER (WHERE m.name = 'StepDownDom')    AS step_down_dom,
  
  MAX(sm.value) FILTER (WHERE m.name = 'FatigueForwardHopNonDomAvg') AS fatigue_forward_hop_non_dom_avg,
  MAX(sm.value) FILTER (WHERE m.name = 'FatigueForwardHopNonDomMax') AS fatigue_forward_hop_non_dom_max,
  MAX(sm.value) FILTER (WHERE m.name = 'FatigueForwardHopDomAvg')    AS fatigue_forward_hop_dom_avg,
  MAX(sm.value) FILTER (WHERE m.name = 'FatigueForwardHopDomMax')    AS fatigue_forward_hop_dom_max


FROM subject s
LEFT JOIN test_session ts ON s.subject_id = ts.subject_id
LEFT JOIN session_measurement sm ON ts.session_id = sm.session_id
LEFT JOIN measurement m ON sm.measurement_id = m.measurement_id
GROUP BY
    s.subject_id,
    s.age,
    s.gender,
    s.weight_lbs,
    s.weight_kg,
    s.height_in,
    s.height_cm,
    s.knee_injury,
    s.dom_limb,
    s.surgery_limb,
    ts.session_id,
    ts.session_date,
    ts.time_since_sx;
